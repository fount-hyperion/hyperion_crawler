# Production í™˜ê²½ ì „ìš© Cloud Build ì„¤ì •
# main ë¸Œëœì¹˜ì—ë§Œ ì ìš©

substitutions:
  _SERVICE_NAME: hyperion-crawler-prod
  _REGION: asia-northeast3
  _SERVICE_ACCOUNT: hyperion-crawler@${PROJECT_ID}.iam.gserviceaccount.com

steps:
  # 1. Python ì˜ì¡´ì„± ì„¤ì¹˜ ë° í…ŒìŠ¤íŠ¸ (Productionì€ í…ŒìŠ¤íŠ¸ í•„ìˆ˜)
  - name: 'python:3.13-slim'
    id: 'test'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        cd api
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        cd ..
        python -m pytest tests/unit -v --tb=short

  # 2. Docker ì´ë¯¸ì§€ ë¹Œë“œ
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build'
    args:
      - 'build'
      - '-t'
      - 'gcr.io/$PROJECT_ID/${_SERVICE_NAME}:${COMMIT_SHA}'
      - '-t'
      - 'gcr.io/$PROJECT_ID/${_SERVICE_NAME}:latest'
      - '.'

  # 3. Container Registryì— í‘¸ì‹œ
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push'
    args:
      - 'push'
      - '--all-tags'
      - 'gcr.io/$PROJECT_ID/${_SERVICE_NAME}'

  # 4. Cloud Runì— ë°°í¬ (Production ì„¤ì •)
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'deploy'
    args:
      - 'run'
      - 'deploy'
      - '${_SERVICE_NAME}'
      - '--image'
      - 'gcr.io/$PROJECT_ID/${_SERVICE_NAME}:${COMMIT_SHA}'
      - '--region'
      - '${_REGION}'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'  # í•„ìš”ì‹œ --no-allow-unauthenticatedë¡œ ë³€ê²½
      - '--memory'
      - '1Gi'  # Productionì€ ë©”ëª¨ë¦¬ ì¦ê°€
      - '--cpu'
      - '2'    # Productionì€ CPU ì¦ê°€
      - '--timeout'
      - '300'
      - '--max-instances'
      - '50'   # Productionì€ ìµœëŒ€ ì¸ìŠ¤í„´ìŠ¤ ì¦ê°€
      - '--min-instances'
      - '1'    # Productionì€ ìµœì†Œ 1ê°œ ì¸ìŠ¤í„´ìŠ¤ ìœ ì§€
      - '--port'
      - '8080'
      - '--service-account'
      - '${_SERVICE_ACCOUNT}'
      - '--set-env-vars'
      - 'ENVIRONMENT=production,GOOGLE_CLOUD_PROJECT=${PROJECT_ID}'

  # 5. ë°°í¬ í™•ì¸
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'verify'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        SERVICE_URL=$(gcloud run services describe ${_SERVICE_NAME} \
          --region ${_REGION} \
          --format 'value(status.url)')
        echo "Production ì„œë¹„ìŠ¤ URL: $${SERVICE_URL}"
        
        # í—¬ìŠ¤ ì²´í¬
        curl -f "$${SERVICE_URL}/health" || exit 1
        echo "Production ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"

  # 6. í”„ë¡œë•ì…˜ ë°°í¬ ì„±ê³µ ì•Œë¦¼
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'notify-success'
    entrypoint: 'bash'
    secretEnv: ['TEAMS_WEBHOOK_URL']
    args:
      - '-c'
      - |
        if [ ! -z "$${TEAMS_WEBHOOK_URL}" ]; then
          SERVICE_URL=$(gcloud run services describe ${_SERVICE_NAME} \
            --region ${_REGION} \
            --format 'value(status.url)')
          
          # Teams ë©”ì‹œì§€ ì¹´ë“œ í˜•ì‹ (í”„ë¡œë•ì…˜ìš©)
          curl -X POST $${TEAMS_WEBHOOK_URL} \
            -H 'Content-Type: application/json' \
            -d '{
              "@type": "MessageCard",
              "@context": "https://schema.org/extensions",
              "themeColor": "0078D4",
              "summary": "Hyperion Crawler í”„ë¡œë•ì…˜ ë°°í¬ ì„±ê³µ",
              "sections": [{
                "activityTitle": "ğŸš€ Hyperion Crawler í”„ë¡œë•ì…˜ ë°°í¬ ì„±ê³µ",
                "facts": [
                  {
                    "name": "í™˜ê²½",
                    "value": "**PRODUCTION**"
                  },
                  {
                    "name": "ë²„ì „",
                    "value": "'"${SHORT_SHA}"'"
                  },
                  {
                    "name": "í”„ë¡œì íŠ¸",
                    "value": "'"${PROJECT_ID}"'"
                  },
                  {
                    "name": "ë°°í¬ ì‹œê°„",
                    "value": "'"$(date +"%Y-%m-%d %H:%M:%S KST")"'"
                  }
                ],
                "markdown": true
              }],
              "potentialAction": [{
                "@type": "OpenUri",
                "name": "í”„ë¡œë•ì…˜ ì„œë¹„ìŠ¤ í™•ì¸",
                "targets": [{
                  "os": "default",
                  "uri": "'"$${SERVICE_URL}"'"
                }]
              },
              {
                "@type": "OpenUri",
                "name": "API ë¬¸ì„œ ë³´ê¸°",
                "targets": [{
                  "os": "default",
                  "uri": "'"$${SERVICE_URL}/docs"'"
                }]
              },
              {
                "@type": "OpenUri",
                "name": "ë¹Œë“œ ë¡œê·¸ ë³´ê¸°",
                "targets": [{
                  "os": "default",
                  "uri": "https://console.cloud.google.com/cloud-build/builds/'"${BUILD_ID}"'?project='"${PROJECT_ID}"'"
                }]
              }]
            }' || true
        fi

# ë¹Œë“œ ë¡œê·¸ë¥¼ Cloud Storageì— ì €ì¥
options:
  logging: GCS_ONLY
  logsBucket: 'gs://${PROJECT_ID}_cloudbuild_logs'
  machineType: 'E2_HIGHCPU_8'  # Productionì€ ë” ë¹ ë¥¸ ë¹Œë“œë¥¼ ìœ„í•´ ê³ ì„±ëŠ¥ ë¨¸ì‹  ì‚¬ìš©

# ë¹Œë“œ ì‹œê°„ ì œí•œ
timeout: '1200s'  # 20ë¶„

# Secret Manager ì„¤ì •
availableSecrets:
  secretManager:
  - versionName: projects/${PROJECT_ID}/secrets/teams-webhook-url/versions/latest
    env: 'TEAMS_WEBHOOK_URL'